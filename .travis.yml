dist: bionic
language: shell
os: linux

services:
  - docker

# skip non-trunk PMM-XXXX/SAAS-XXXX branch builds, but still build pull requests
branches:
  except:
    - /^PMM\-\d{3,5}/
    - /^SAAS\-\d{2,5}/

cache:
  directories:
    - /home/travis/go-build

before_cache:
  # extract Go build cache
  - docker exec pmm-managed-server go clean -testcache
  - rm -fr /home/travis/go-build
  - docker cp pmm-managed-server:/root/.cache/go-build /home/travis/go-build

env:
  global:
    - CODECOV_ENV=GO_VERSION,PMM_SERVER_IMAGE

    # There is no case when pmm-update is older than pmm-managed (pmm-update self-updates first),
    # so there is no need to test with old PMM Server versions.
    # However, there may be a need to use a different devcontainer image once
    # https://jira.percona.com/browse/PMM-5451 is implemented.
    - PMM_SERVER_IMAGE=perconalab/pmm-server:dev-latest

    # AWS - PMM Autotest account.
    # Travis secrets are not exposed to pull requests from forks: https://docs.travis-ci.com/user/pull-requests#pull-requests-and-security-restrictions
    - AWS_ACCESS_KEY=AKIAZPBRO3QWCEHJTL35
    # AWS_SECRET_KEY
    - secure: "MmmBUw5444lgnB5xPKgArr8iCtsTqWZsqbi8DI+YWoyl79yxGxUaGL0zgd9ZvKNAyaZ62G/nUbUoe88VbnFRjqP5HVm9RW9kYQIuoqqGUjVr2KVWUMIX+aclkuRIm8VwsW4BJNjerV1WaYHen4NWAnsattULNKMrDVn9XHCfYOhNHcf/U4PSsdNyWAtGSzaweDCxvF9VaiDXqHyED8uyXISl2hz5wD7BAxCftstm0+38XsUp4PY7ne/GVnq/SFb7pNIHfdnWpakBJJd9v1VrjqWbUije0H9b12dn5YElZOWTRRxAED8glEkknh9p1LmpLBH7FtS4Q617N/jgna9bXyR4Re8ATHj0PAplKnkEYDqLt7i6NkTtBEvB0QOicBWYrqTJ+XjqoLCBa9UZUfC+6Mg0rYv17dbghHeoP8qGJH0dAIuy3U1IDac80y1QLz+Q0Dgk+rkbogDepqgOK1NLr0fXiSZZNZ776b+TsdiJZiBO6piBdr2hjxPy5wGaMKGS4vZ8uWR71mmOeS/y+9nhIfHBrvdKDJHgCy9aioj7vjRxBRerUTqQ4BDW/LAv8cWS/Dwa48pDUq5DwyGA2lYIQuCBHq/cIqqF68VcnbLrJ4++LzYYzcbmStOFT0zzyMZl/Q7Qjl5T3UBhhG5pVwXWC03EaS67fv6hsJQDwMmAw+g="
    # REVIEWDOG_GITHUB_API_TOKEN
    - secure: "BlAz9vxJTDs+COfcOynpnprhF0yudfwMAqsPro/VsHJa+gpKlIQh1P14cmjLsa7XTaFgklrTUvyPy4UY5LNy2ZEtvH8iy4wCwhC91X/Fc+axuO/jKEaKPMkybp5zDZevhMrYnW93TEqizoul+gtTD7P2t2JpX0w/2tzOZlM39HnZFULfYL5/N1WforbbeXsPsuLqhV3tzsdKqpz2d1Jc/QUMNhmMvjiSNiSPrcQ4wZkOjCrSiRAYe+FCftCjtH8452NFG52tu78owv3ZeuDMjfVcRvLYrfZzTVi5u9+f1VTbL016pphGVXNMNLSRaV1JKVmMqwbAtibcjg4lJ8xGpah3kJcrj2vVJUKuehi2XK+RMCTXb0CDKgSMA1t+Haw929JQtQLgI7Kxfy7A9w0LZ/XuOOeOIKQrMyx720e5Ufou4ejMZd97nUIj7VqybPabcFP2AFFOHqjf/SIfjJEj1k0uyv36ZZ3PN9FxMdGzJCFdOYKvEi9oep3wEzCCPOaFV5/PyyaFaWKBhXL5rkHB0S2kTqgKqjRSWrvgM5u/qJ/ILp4093Ms28C2FgFY5jEfdiq0Emd/C5nnz16FNpeYdwsia35V1Cc3NYFXpxCd5Sq9LSK4wQOp3/I8+nrj9FDJT+u/MhIICuenZgQeoBAuD5cBH4Y7wDxXqWHmGBfs9nA="

  jobs:
    # what we used for the latest PMM release
    - GO_VERSION=1.15.x
    # what will be used for PMM releases soon
    - GO_VERSION=1.16.x
    # the latest HEAD
    - GO_VERSION=master

jobs:
  fast_finish: true
  allow_failures:
    - env: GO_VERSION=1.16.x
    - env: GO_VERSION=master

before_install:
  - env
  - make env-compose-up

  # restore Go build cache
  - docker cp /home/travis/go-build pmm-managed-server:/root/.cache/go-build
  - docker exec pmm-managed-server ls /root/.cache/go-build

install:
  # install devcontainer
  - make env-devcontainer

before_script:
  # ensure that generated files are not changed
  - make env TARGET=gen
  - make env TARGET=format
  - git status
  - git diff --exit-code

script:
  - make env TARGET=travis

after_success:
  - curl https://codecov.io/bash > codecov
  - chmod +x codecov
  - ./codecov -f cover.out -F all,cover -X fix
  - ./codecov -f crosscover.out -F all,crosscover -X fix
  - ./codecov -f race-crosscover.out -F update,crosscover -X fix

notifications:
  slack:
    on_success: change
    on_failure: always
    rooms:
      - secure: "kaX+LPX0i6FnUg+kVe/oi8K+xRghuu8COpnr6hPD+5KTr1YVKE82drZxwL8lztjJ/2RUiB0ZOAkQbm11ptkNn6RgHY6n4UhajuybgR3RJRH9FN8ear6sOBDBCFf+/NHPe4qiLMFhGQ+3IQLs6+4lJmca23cID1Qy4ZBMZ3LtnK3NDpN0KiD6QnUS2LgfRUy6UK4qkKpq0EDqTZxiOw8JHWYGIWeG93gR5M2pN8cPDdeKlWsenY7WAhmAIxdTw7UWGW/bpjbpEJ+/BD+nQPMVkqlZilWcRCSz7N33rJURl654bBXI3Vfa3FRBW+zf9rxTJJzrFyDBAaz/ME7YTTEroXHe8wDTXgCdIrAfzXWAUtSYtPPMXKHgJ3xvsciK4dvqDe46PueQUa9sLFRbJDdhoLOOyVVof7bY+mYG4PHyxlbLYSZFAPgXFqRhVrNkgUWlit3v5vQAcqEJVADb4Ii2BW6xUyVGXGo/y+cRZxgzpFbI2yMY/crrgjYI+7vMWPwQf+tx5wccXzjGhmv/tKTnn1HYIOfKUQTHoKR/vttAhRXstaKV0SCejKzAq1ajr2Rv6NM9tdjJJ7ZnE2qAwjpnYuvNvp6ewcDB87qYQvt491aKTLvEzH9YMYhuNro976yAPvRPA5TxZw6EyZFzCzUibx9sxtMo5G3BdG/CGDBjtTk="
