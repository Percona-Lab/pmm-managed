dist: trusty
sudo: required
language: go

go:
  - 1.9.x
  - master

matrix:
  allow_failures:
    - go: master

env:
  global:
    # Secure variables are not exposed for external pull requests: https://docs.travis-ci.com/user/pull-requests#Pull-Requests-and-Security-Restrictions
    # AWS_ACCESS_KEY_ID
    - secure: M3qtt/tKgHClP4F8W58MV41uYu3vMIzhfjED2tLWM6szEnF8MSzEvKE0AsM5BC9NGcR5ghqz1wvSt6M0qdXDeMojOpmbesvIx/uoFADomxxp13CqC418TMgzuUNrX9xKp++S5Y0aW67F/bT/6JGlAv8bd1xshqfDX2YiRV0yrQz8Wx3BASCvmv2R26bipCgMHsoHBCxh3JYBMOMtnBeRoN/QTTel94+cmO5V5xsaJo78KyrR12+O5lrj2vFq+/WYPOAug8ibPZkCl4mSduMesd3qujGpqp1V3MchfgaIMlJwIoSkxVO6kfAjegT+abnExoIOmuUX6mPCVX64fdpAXdyckH1sn7PTwLZ2uju8IdrYfAK8N3qvNNufQ5We+9+5SyG5F2KvfS8+QhBrlTeYt6WAjtNWYOwvwxIUGKiWhx11BDj6VkkhpsNr2G8CwxyMT7ZgmfkrtLy7/FCNORMLgUfDF/O9o8ZDN6u2PNaofYZPW1uqXZrF9Pn4pz5IYsJqZ1zcqTopjEXvRGgDamDARC7AZPoR+0s9+h4gdegrWJqdEovLSXqk1Ii7XzQuY7h+/r3EKmHvPvFLtQL4jvKY2Dj4Dl1ZKMsc5GGDkSgvKRs/uyvyLP6WsWqe4woaFgxxNgOBqYyZxbU3FeISopIWKVjSkV7ek/Dh3AfwLLqYSP0=
    # AWS_SECRET_ACCESS_KEY
    - secure: Hh+wXkJtSNCBNquDs9u91ai6vMK3Ajw9srwyH+Ie9rLZAbSYFOrS7BymedkR8Sc7mBKfb3pDLN1X0O02QZELO5qDDy0QLR2+HGoNPqBhZiJaQS1oPuMwHWIa5XQo8+kJWlXWlhWMiIilFUJ2AAzDLANhhVrUQfMX3HCQl8KY1oLjBt7hU213JFaO7vtU1pbvR9X/R3WA7R/8gxR8sGEFLrWQC4ADF5JAiSY78SxmU2NPGq+1YkmtH2DFsfibL4WvNnPgbhScjii1LQQHn1cqxxM++VeaJnbPUaY5YFAPpaadruc5j0UkVYv1mZyW6QGFDD9aIZDpgMc4surUBs/TBB5U9HMQx9lMMQ7xZim+GoVAo5Xv7pdlYo69gmi+/r9ZQ0+Nr9sZzuboya/4OqIzodGv5BruwSbuBs/i4eIa8UGkoC4CHz9aaKRhWnFfRlo0w/1Vc75mMHrz63xuUV9XaMYYGQEOXMyDt4HvONasu0BPC43ZsTOqW/qJVpR88oe5uwkdeNfnPTdKt6hsPTeSleNpzGINLmiPto61Qytz2eqOFSo193ZCUrTfr15pYfKYltD/xx5Ytto3/dMp7RQ/ZIav8lSjNexmUC1g69LY6utZeoUkjLVwu3WRTtWaI4QcPg6HmE4UgyIm4dqGI21m6jOg52mnTK+C5stRop1sJXo=

    - MYSQL_IMAGE=percona/percona-server:5.7

  matrix:
    - PROMETHEUS_IMAGE=prom/prometheus:v1.8.2
      ALERTMANAGER_IMAGE=prom/alertmanager:v0.9.1
      CONSUL_IMAGE=consul:0.8.5
    - PROMETHEUS_IMAGE=prom/prometheus:v1.8.2
      ALERTMANAGER_IMAGE=prom/alertmanager:v0.9.1
      CONSUL_IMAGE=consul:1.0.0
    # TODO
    # - PROMETHEUS_IMAGE=prom/prometheus:master
    #   ALERTMANAGER_IMAGE=prom/alertmanager:master
    #   CONSUL_IMAGE=consul:latest

before_install:
  # no package for Trusty yet
  # - sudo add-apt-repository -y ppa:maarten-fonville/protobuf
  # - sudo apt-get -qq update
  # - sudo apt-get install -y protobuf

  # install protoc the hard way
  # - git clone --depth 1 --branch v3.3.2 https://github.com/google/protobuf /tmp/protobuf
  # - cd /tmp/protobuf
  # - ./autogen.sh
  # - ./configure
  # - make -j2
  # - sudo make install
  # - sudo ldconfig

  # install compiled release
  - wget https://github.com/google/protobuf/releases/download/v3.4.0/protoc-3.4.0-linux-x86_64.zip
  - unzip -q protoc-3.4.0-linux-x86_64.zip
  - sudo install -d /usr/local/include/google/protobuf/compiler
  - sudo install -m 755 bin/protoc /usr/local/bin/
  - sudo install -m 644 include/google/protobuf/*.proto /usr/local/include/google/protobuf/
  - sudo install -m 644 include/google/protobuf/compiler/*.proto /usr/local/include/google/protobuf/compiler/

  - protoc --version

script:
  - sudo service mysql stop
  - docker-compose up -d

  # check that generated files are not changed
  - make init gen
  - git diff --exit-code

  - make cover

after_success:
  - bash <(curl -s https://codecov.io/bash) -X fix

notifications:
  slack:
    on_success: change
    on_failure: always
    rooms:
      secure: QDKp28RJiVnst5gGKSKhVWvyIacYFLvl4eypPQoagrUm7VlQlGdmExH841OtURbqwNNsQoai2kP1XfxxSTPtTzmp6rMsBH4D4+cAfpqE2xgP/zQ1ctbA7B4hSAGu0FkAzyhiQb6HaGIeELaTiS5uTgwHn64BNgNtf8rC3mCIUanKlpAwPOejDOvldjkL3TzNkjnv9kujLQhiSSlldMownb0gNeSiH2HfYAZ9XT5wQj6rBEGI2Mk5xBzkEduLpHMe6r8Ocko3j3q3czrNrlrqgPiTzYIh+A1h6cSGu4xe6C3WmANVbHi/ieeM3YM+pT1ff5Mx0g75Kyi18zBCSWL4tBOeu+ciHPAPKFGx7sv5ivLNzoKJm/Fc3AsdkkAvSHErsrRCWdwemRveSdbNOkwDybNSso3ERRZ8YuWIP5rdKb8HIprVuMrvlrpjXi5p901Nabt7Pw4mgDBVJIIvZn8PJ4N/0T+RGO2bV38JlWIutLFHFcHcQ2QPZOiGPffxbtfmU7x7+J4QCHhA4ucYkwzxEb7UZcGpSxz3+zVoP25c480Z56KInkxIEi0LBEqw2s7MqsKpgho4KJIpCbciDhPN7MTm4aVeYjtJ0GgIbgKXuaLWMUMcYQ0yTHUHweGMHLSF/k7cdP8WSb4z1LtJqxKzye9IcejdacVPhdLzHaprW7w=
